# PRODUCTION Environment - default.conf

# Variables for environment-based configuration
map $http_host $minio_bucket {
    default "prod";  # Use production bucket by default
}

# Security rate limiting maps
map $request_uri $rate_limit_key {
    ~^/api/ $binary_remote_addr;
    ~^/admin/ $binary_remote_addr;
    default "";
}

upstream backend_upstream {
    server backend:8000;
    keepalive 64;  # Increased for production
    keepalive_requests 1000;  # More requests per connection
    keepalive_timeout 120s;   # Longer timeout for production
}

# Frontend upstream (uncomment to enable)
# upstream frontend_upstream {
#     server frontend:80;
#     keepalive 64;
#     keepalive_requests 1000;
#     keepalive_timeout 120s;
# }

upstream minio_upstream {
    server minio:9002;
    keepalive 64;  # Increased for production
    keepalive_requests 1000;
    keepalive_timeout 120s;
}

upstream minio_console_upstream {
    server minio:9001;
    keepalive 32;  # Console needs fewer connections
    keepalive_requests 500;
    keepalive_timeout 60s;
}

server {
    listen 80 default_server;
    server_name _;
    client_max_body_size 100M;

    # Comprehensive security headers for production
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; frame-ancestors 'none';" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()" always;

    # Production environment header
    add_header X-Environment "production" always;

    # MinIO storage location with production optimizations
    location ~ ^/storage/(?<bucket>[^/]+)(/.*)?$ {
        # Rate limiting for storage access
        limit_req zone=general burst=20 nodelay;

        # Strict CORS headers for production
        add_header 'Access-Control-Allow-Origin' '$http_origin' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-amz-content-sha256,x-amz-date,x-amz-user-agent' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,ETag,x-amz-request-id,x-amz-version-id' always;
        add_header 'Access-Control-Max-Age' 3600 always;  # Cache preflight for 1 hour

        # Handle preflight requests efficiently
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        proxy_pass http://minio_upstream/$bucket$2;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;

        chunked_transfer_encoding off;

        # Production buffering for better performance
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 16 128k;
        proxy_busy_buffers_size 256k;
        proxy_temp_file_write_size 256k;

        # Production timeouts
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        send_timeout 120s;

        # Caching for static assets
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|pdf|txt|tar|zip)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }

    # Legacy MinIO route (backward compatibility)
    location /default {
        return 301 /storage/default$request_uri;
    }

    # Backend API routes with production security
    location ~ ^/api/ {
        # API rate limiting
        limit_req zone=api burst=10 nodelay;

        proxy_pass http://backend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;

        # Production timeouts
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # Optimized buffering for production
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 16 128k;
        proxy_busy_buffers_size 256k;

        # Minimal headers for production (no debug info)
        add_header X-Request-ID $request_id always;
    }

    # Admin routes with strict rate limiting
    location ~ ^/admin/ {
        # Strict admin rate limiting
        limit_req zone=admin burst=2 nodelay;

        # Additional security for admin
        deny 192.168.0.0/16;  # Block private networks if needed
        # allow trusted_ip_range;  # Uncomment and specify trusted IPs

        proxy_pass http://backend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;

        # Production timeouts
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # Optimized buffering
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 16 128k;
        proxy_busy_buffers_size 256k;

        # Security logging for admin access
        add_header X-Request-ID $request_id always;
        access_log /var/log/nginx/admin.log prod;
    }

    # Frontend application (uncomment to enable)
    # location / {
    #     proxy_pass http://frontend_upstream;
    #     proxy_http_version 1.1;
    #     proxy_set_header Connection "";
    #
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_set_header X-Forwarded-Host $server_name;
    #
    #     proxy_connect_timeout 30s;
    #     proxy_send_timeout 30s;
    #     proxy_read_timeout 30s;
    #
    #     # Enable caching for static assets
    #     proxy_buffering on;
    #     proxy_buffer_size 64k;
    #     proxy_buffers 8 64k;
    #     proxy_cache_valid 200 302 10m;
    #     proxy_cache_valid 404 1m;
    #
    #     add_header X-Upstream $upstream_addr always;
    #     add_header X-Request-ID $request_id always;
    # }

    # Health check endpoint
    location /health {
        access_log off;
        add_header Content-Type text/plain always;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        return 200 'healthy\n';
    }

    # Production monitoring with enhanced security
    location /nginx-status {
        stub_status on;
        access_log off;

        # Strict access control for production
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        # allow monitoring_server_ip;  # Add specific monitoring IPs
        deny all;

        add_header Content-Type text/plain always;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    }

    # Security hardening
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
        return 444;  # Close connection without response
    }

    # Block common attack patterns
    location ~* \.(php|jsp|cgi|asp|aspx)$ {
        deny all;
        access_log off;
        log_not_found off;
        return 444;
    }

    # Block sensitive files
    location ~* /(\.git|\.svn|\.env|web\.config|\.htaccess|composer\.(json|lock)|package(-lock)?\.json)$ {
        deny all;
        access_log off;
        log_not_found off;
        return 444;
    }

    # Rate limited default fallback
    location / {
        limit_req zone=general burst=5 nodelay;

        return 404 '{"error": "Not Found", "message": "The requested resource was not found.", "timestamp": "$time_iso8601"}\n';
        add_header Content-Type application/json always;
        add_header X-Request-ID $request_id always;
    }
}
