# DEV Environment - default.conf

# Variables for environment-based configuration
map $http_host $minio_bucket {
    default "default";  # Use dev bucket by default
}

upstream backend_upstream {
    server backend:8000;
    keepalive 8;  # Reduced for dev
    keepalive_requests 50;
    keepalive_timeout 30s;
}

# Frontend upstream (uncomment to enable)
# upstream frontend_upstream {
#     server frontend:80;
#     keepalive 8;
#     keepalive_requests 50;
#     keepalive_timeout 30s;
# }

upstream minio_upstream {
    server minio:9002;
    keepalive 8;  # Reduced for dev
    keepalive_requests 50;
    keepalive_timeout 30s;
}

upstream minio_console_upstream {
    server minio:9001;
    keepalive 8;  # Reduced for dev
    keepalive_requests 50;
    keepalive_timeout 30s;
}

server {
    listen 80 default_server;
    server_name _;
    client_max_body_size 500M;  # Larger for dev testing

    # Relaxed security headers for development
    # add_header X-Frame-Options "SAMEORIGIN" always;  # Commented out for easier dev
    # add_header X-Content-Type-Options "nosniff" always;  # Commented out for easier dev
    # add_header X-XSS-Protection "1; mode=block" always;  # Commented out for easier dev
    # add_header Referrer-Policy "strict-origin-when-cross-origin" always;  # Commented out for easier dev

    # Development debug headers
    add_header X-Environment "development" always;
    add_header X-Debug "enabled" always;

    # MinIO storage location (dynamic bucket support)
    location ~ ^/storage/(?<bucket>[^/]+)(/.*)?$ {
        # Permissive CORS headers for development
        add_header 'Access-Control-Allow-Origin' '*' always;  # Allow all origins in dev
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
        add_header 'Access-Control-Allow-Headers' '*' always;  # Allow all headers in dev
        add_header 'Access-Control-Expose-Headers' '*' always; # Expose all headers in dev

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Max-Age' 86400;  # Cache preflight for 24h
            return 204;
        }

        proxy_pass http://minio_upstream/$bucket$2;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;

        chunked_transfer_encoding off;
        proxy_buffering off;  # No buffering for immediate response

        # Shorter timeouts for development
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        send_timeout 60s;
    }

    # Legacy MinIO route (backward compatibility)
    location ~ ^/default(/.*)?$ {
        return 301 /storage/default$1;
    }

    # Backend API routes
    location ~ ^/(api|admin)/ {
        proxy_pass http://backend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;

        # Shorter timeouts for development
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Minimal buffering for immediate response
        proxy_buffering off;
        proxy_buffer_size 32k;  # Smaller buffers for dev
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;

        # Extensive debug headers for development
        add_header X-Upstream $upstream_addr always;
        add_header X-Request-ID $request_id always;
        add_header X-Backend-Response-Time $upstream_response_time always;
        add_header X-Request-Start $msec always;

        # No rate limiting in development
        # Developers need unrestricted access for testing
    }

    # Frontend application (uncomment to enable)
    # location / {
    #     proxy_pass http://frontend_upstream;
    #     proxy_http_version 1.1;
    #     proxy_set_header Connection "";
    #
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_set_header X-Forwarded-Host $server_name;
    #
    #     proxy_connect_timeout 30s;
    #     proxy_send_timeout 30s;
    #     proxy_read_timeout 30s;
    #
    #     # Enable caching for static assets
    #     proxy_buffering on;
    #     proxy_buffer_size 64k;
    #     proxy_buffers 8 64k;
    #     proxy_cache_valid 200 302 10m;
    #     proxy_cache_valid 404 1m;
    #
    #     add_header X-Upstream $upstream_addr always;
    #     add_header X-Request-ID $request_id always;
    # }

    # Health check endpoint
    location /health {
        access_log off;
        add_header Content-Type text/plain always;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        return 200 'healthy\n';
    }

    # Nginx status monitoring
    location /nginx-status {
        stub_status on;
        access_log off;

        # Restrict access to monitoring systems
        allow 127.0.0.1;
        allow 10.0.0.0/8;     # Private networks
        allow 172.16.0.0/12;  # Docker networks
        allow 192.168.0.0/16; # Local networks
        deny all;

        add_header Content-Type text/plain always;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Default fallback for unmatched routes
    location / {
        return 404 '{"error": "Not Found", "message": "The requested resource was not found on this server."}\n';
        add_header Content-Type application/json always;
    }
}
